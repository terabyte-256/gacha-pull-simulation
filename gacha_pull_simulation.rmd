---
title: "Gacha Pull Simulation Results"
output:
  pdf_document:
    toc: true
  html_document:
    theme: cosmo
    toc: true
encoding: "UTF-8"
---

```{r setup, include=FALSE}
library(ggplot2)
library(knitr)
library(dplyr)
knitr::opts_chunk$set(echo = FALSE)
```
```{r constants}
FIVE_STAR_CHARACTER_CHANCE <- 0.006
FIVE_STAR_CONE_CHANCE <- 0.008

CHARACTER_SOFT_PITY <- 74
SOFT_PITY_INCREMENT <- 0.062
CHARACTER_PITY <- 90

CONE_SOFT_PITY <- 64
CONE_PITY <- 80

LIMITED_CHARACTER_CHANCE <- 0.5
LIMITED_CONE_CHANCE <- 0.75
```
```{r functions}
algo <- function() {
    
    pulls_left <- 90
    
    current_character_pity <- 0
    current_cone_pity <- 0

    current_character_guaranteed <- FALSE
    current_cone_guaranteed <- FALSE

    character_success <- 0

    character_copies <- 0
    cone_copies <- 0

    cone_successes <- 0

    while (pulls_left > 0 && ((character_success < character_copies) || (character_success == character_copies && character_copies == 0))) {
        random_value <- runif(1)
       
        current_five_star_chance <- FIVE_STAR_CHARACTER_CHANCE

        if ((cone_copies > 0 && character_success < character_copies) || (character_success == character_copies && character_copies == 0)) {
            
            current_five_star_chance += SOFT_PITY_INCREMENT * max(current_character_pity - CHARACTER_SOFT_PITY, 0.0)
        
            if (random_value < current_five_star_chance || current_character_pity + 1 == CHARACTER_PITY) {
                if (current_character_guaranteed || runif(1) < LIMITED_CHARACTER_CHANCE) {
                    return(
                        pull_number = pulls_left
                        cones_pulled = cone_successes
                    )
                } else {
                    current_character_pity = 0
                    current_character_guaranteed = TRUE
                }
            } else {
                current_character_pity += 1
            }
        } else {
            # cone prob
            current_five_star_chance = FIVE_STAR_CONE_CHANCE
            current_five_star_chance = SOFT_PITY_INCREMENT * math(current_cone_pity - CONE_SOFT_PITY, 0.0)

            if (random_value < current_five_star_chance || current_cone_pity + 1 == CONE_PITY) {
                if (current_cone_guaranteed || runif(1) < LIMITED_CONE_CHANCE) {
                    cone_successes += 1
                    current_cone_guaranteed = FALSE
                } else {
                    current_cone_pity = 0
                    current_cone_guaranteed = TRUE
                }
            } else {
                current_cone_pity += 1
            }
        }

        pulls_left -= 1
    }

    return(
        pull_number = 90
        cones_pulled = cone_successes
    )

}

pullsystem <- function(iteration) {
    BATCH_SIZE <- 1000
    results <- numeric()
    
    batch_starts <- seq(1, iteration, by = BATCH_SIZE)
    
    for(i in batch_starts) {
        batch_size <- min(BATCH_SIZE, iteration - i + 1)
        batch_results <- sapply(1:batch_size, function(x) algo())
        results <- c(results, batch_results)
    }
    
    return(results)
}


num_sims <- 10000000  # Default value 10M

main <- function() {
    start_time <- Sys.time()
    results <- pullsystem(num_sims)
    end_time <- Sys.time()
    elapsed_time <- difftime(end_time, start_time, units="secs")
    
    results_df <- data.frame(pulls = results)
    
    stats <- list(
        total_sims = num_sims,
        average = mean(results),
        median = median(results),
        sd = sd(results),
        min = min(results),
        max = max(results)
    )
    
    hist_plot <- ggplot(results_df, aes(x=pulls)) +
        geom_histogram(binwidth=1, fill="skyblue", color="black") +
        theme_minimal() +
        labs(title="Distribution of Pulls Until Success",
             x="Number of Pulls",
             y="Frequency")
    
    return(list(
        geom_histogram(binwidth=1, fill="skyblue", color="black") +
        theme_minimal() +
        labs(title="Distribution of Pulls Until Success",
             x="Number of Pulls",
             y="Frequency")
    
    cone_plot <- ggplot(results_df, aes(x=cones)) +
        geom_histogram(binwidth=1, fill="lightgreen", color="black") +
        theme_minimal() +
        labs(title="Distribution of Light Cones Obtained",
             x="Number of Light Cones",
             y="Frequency")
    
    return(list(
        results = results_df,
        stats = stats,
        pulls_plot = hist_plot,
        cones_plot = cone_plot,
        time = elapsed_time
    ))
}
```

## Simulation Results

```{r run_simulation}
sim_results <- main()
```

### Summary Statistics

```{r stats_table}
stats_df <- with(sim_results$stats, data.frame(
    Metric = c("Total Simulations", "Average Pulls", "Median Pulls", 
               "Standard Deviation", "Minimum Pulls", "Maximum Pulls",
               "Average Cones", "Median Cones", "Standard Deviation Cones"),
    Value = c(total_sims, pulls_average, pulls_median, pulls_sd, pulls_min, pulls_max,
              cones_average, cones_median, cones_sd)
))
kable(stats_df, digits = 2)
```

## Distribution Plot

```{r plot_results}
sim_results$pulls_plot
```

## Light Cones Distribution Plot

```{r plot_cones}
sim_results$cones_plot
```

## Pull Frequency Distribution

```{r cumulative_prob}

pull_freq <- as.data.frame(table(sim_results$results$pulls))
names(pull_freq) <- c("Number of Pulls", "Frequency")
pull_freq$"Percentage (%)" <- round(pull_freq$Frequency / sum(pull_freq$Frequency) * 100, 4)

# Calculate cumulative probabilities
cum_prob <- pull_freq %>%
  arrange(`Number of Pulls`) %>%
  mutate(
    `Cumulative Frequency` = cumsum(Frequency),
    `Cumulative Probability` = round(`Cumulative Frequency` / sum(Frequency) * 100, 4)
  )


# Create cumulative probability plot
cum_plot <- ggplot(cum_prob, aes(x = as.numeric(as.character(`Number of Pulls`)), 
                                y = `Cumulative Probability`)) +
  geom_line(color = "blue") +
  geom_point(color = "red", size = 2) +
  labs(title = "Cumulative Probability of Getting 5-star Character",
       x = "Number of Pulls",
       y = "Cumulative Probability (%)") +
  theme_minimal()

# Display table and plot
cum_plot
kable(cum_prob, row.names = FALSE)
```

### Execution Details

```{r time_info}
cat(sprintf("Simulation completed in %.2f seconds", 
            as.numeric(sim_results$time)))
```


### Execution Details

```{r time_info}
cat(sprintf("Simulation completed in %.2f seconds", 
            as.numeric(sim_results$time)))
```
````

